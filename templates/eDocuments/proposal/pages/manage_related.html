{% extends "eDocuments/layouts/layout.html" %}

{% block title %}ຈັດການຜູ້ກ່ຽວຂ້ອງ{% endblock %}

{% block head %}
<style>
    .card-box {
        max-height: 400px;
        overflow-y: auto;
    }

    .card-item {
        width: 100%;
        text-align: start;
        background-color: var(--third-color);
        line-height: 1.5rem;
    }

    header button { 
        background-color: transparent;
        border: none;
    }

    .dropdown-toggle::after {
        display: none !important;
    }

    #list_group li {
        list-style: none;
    }
</style>
{% endblock %}

{% block header %}
<div class="d-flex justify-content-between px-3">
    <button onclick="window.location.href='/pps_list'" class="first-btn">
        <i class="bi bi-chevron-left text-white"></i>
    </button>
    ຈັດການຜູ້ກ່ຽວຂ້ອງ
    <button disabled onclick="window.location.href='/add_document'" class="second-btn">
        <i class="bi bi-plus-circle-fill" style="color: #276FB7"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<main class="d-flex justify-content-between flex-column gap-3 mt-2">
    <div class="form-group">
        <label for="" class="form-label fw-medium">ປະເພດເອກະສານ</label>
        <select name="" id="docType_code" onchange="sendDoctypeCodeToServer()" class="form-select shadow-sm">
            <option value="" selected class="d-none" style="display: none;">ເລືອກປະເພດເອກະສານ</option>
            {% for data in docType_data %}
            <option value="{{ data['code'] }}">{{ data['name_1'] }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="" class="form-label fw-medium">ຜູ້ກ່ຽວຂ້ອງ</label>
        <div class="input-group">
            <select class="form-select shadow-sm" id="related_data" aria-label="Example select with button addon">
                <option value="" selected class="d-none" style="display: none;">ເລືອກຜູ້ກ່ຽວຂ້ອງ</option>
                {% for data in related_data %}
                <option value="{{ data['code'] }}">{{ loop.index }}. {{ data['name_1'] }}</option>
                {% endfor %}
            </select>
            <a id="related_code" class="btn text-white shadow-sm" type="button"
                style="background-color: var(--second-color);">ເພິ່ມ</a>
        </div>
    </div>

    <div id="list_group">
        <label id="list_label"></label>
        <ul id="relatedList" style="line-height: 1.5rem; margin: 0; padding: 0;"></ul>
        <div id="del_box" class="mt-3"></div>
    </div>
</main>

<script>

    // Add related
    document.getElementById('related_code').addEventListener('click', function add_related() {
        const related_data = document.getElementById('related_data').value;
        const docType_code = document.getElementById('docType_code').value;

        if (!related_data || !docType_code) {
            console.error("Missing required data!");
            return;
        }

        fetch('/insert_related', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ related_code: related_data, doc_type_code: docType_code })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        if (errorData.error) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'ຕຳແໜ່ງນີ້ມີແລ້ວ',
                                confirmButtonText: 'ຕົກລົງ',
                                confirmButtonColor: '#276FB7'
                            });
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(() => {
                clearValues();
                sendDoctypeCodeToServer();
            })
            .catch(error => console.error('Error sending data to server:', error));
    });

    // Delete and show related list
    function updateList(related_data) {
        const list = document.getElementById('relatedList');
        const del_box = document.getElementById('del_box');
        const label = document.getElementById('list_label');
        list.innerHTML = '';
        del_box.innerHTML = '';

        if (related_data.length === 0) {
            label.innerHTML = "<label class='form-label fw-medium'>ລາຍການຜູ້ກ່ຽວຂ້ອງ</label>";
            list.innerHTML = "<li class='text-danger'>ເອກະສານນີ້ຍັງບໍ່ມີລາຍການຜູ້ກ່ຽວຂ້ອງ!</li>";
            return;
        }

        related_data.forEach((person, index) => {
            const listItem = document.createElement('li');
            label.innerHTML = "<label class='form-label fw-medium'>ລາຍການຜູ້ກ່ຽວຂ້ອງ</label>";
            listItem.textContent = `${index + 1}. ${person.related_person_name}`;
            list.appendChild(listItem);
        });

        const delButton = document.createElement('a');
        delButton.id = 'del_related';
        delButton.className = 'btn btn-sm bg-danger text-white fw-bold shadow-sm';
        delButton.textContent = 'ລຶບລາຍການ';

        delButton.addEventListener('click', function del_related() {
            const docType_code = document.getElementById('docType_code').value;

            Swal.fire({
                title: 'ລຶບຂໍ້ມູນ',
                text: "ກົດຢຶນຢັນເພື່ອລຶບລາຍການ!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ຢຶນຢັນ',
                cancelButtonText: 'ຍົກເລີກ'
            }).then((result) => {
                if (result.isConfirmed) {

                    fetch('/del_related', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ type_code: docType_code })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(related_data => {
                            // console.log("Related data from server:", related_data);
                            sendDoctypeCodeToServer()
                            clearValues()
                        })
                        .catch(error => console.error('Error sending data to server:', error));
                }
            });
        });

        del_box.appendChild(delButton);
    }

    // send Document type code to server
    function sendDoctypeCodeToServer() {
        const docType_code = document.getElementById('docType_code').value;
 
        fetch('/get_related_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ type_code: docType_code })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(related_data => {
                // console.log("Related data from server:", related_data);
                updateList(related_data || []);
                clearValues()
            })
            .catch(error => console.error('Error sending data to server:', error));
    }

    function clearValues() {

        const selectElement = document.getElementById('related_data');
        if (selectElement) {
            selectElement.selectedIndex = 0;
        }
    }
</script>

{% endblock %}